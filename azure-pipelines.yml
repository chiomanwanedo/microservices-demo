trigger:
  branches:
    include:
      - main

parameters:
  - name: services
    type: object
    default:
      - adservice
      - cartservice
      - checkoutservice
      - currencyservice
      - emailservice
      - frontend
      - loadgenerator
      - paymentservice
      - productcatalogservice
      - recommendationservice
      - shippingservice
      - shoppingassistantservice

stages:
  - stage: BuildAndPush
    jobs:
      - job: DockerBuild
        pool:
          name: 'Default'
        steps:
          - checkout: self

          - task: Docker@2
            displayName: 'Login to ACR'
            inputs:
              command: login
              containerRegistry: 'online-boutique'

          # âœ… Print services loop
          - ${{ each service in parameters.services }}:
              - script: echo "Service: ${{ service }}"
                displayName: 'Print ${{ service }}'

          # âœ… Hard-coded Docker build to test
          - task: Docker@2
            displayName: 'Hard Build adservice'
            inputs:
              command: buildAndPush
              repository: 'adservice'
              dockerfile: 'src/adservice/Dockerfile'
              containerRegistry: 'online-boutique'
              tags: '$(Build.BuildId)'

          # ðŸ”„ (Commented) Full loop to troubleshoot later
          # - ${{ each service in parameters.services }}:
          #     - task: Docker@2
          #       displayName: 'Build and Push ${{ service }}'
          #       inputs:
          #         command: buildAndPush
          #         repository: '${{ service }}'
          #         dockerfile: 'src/${{ service }}/Dockerfile'
          #         containerRegistry: 'online-boutique'
          #         tags: '$(Build.BuildId)'
